import { createClient } from '@supabase/supabase-js';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';

// Load env vars
dotenv.config({ path: '.env.local' });

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY; // Need Service Role for table creation

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase credentials in .env.local');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function setup() {
    console.log('Starting Supabase setup...');

    // 1. Read local content
    const dataPath = path.join(__dirname, '../data/content.json');
    const rawData = await fs.readFile(dataPath, 'utf-8');
    const content = JSON.parse(rawData);
    console.log('Read local content.json');

    // 2. Create table (Standard SQL via REST is not possible without extensions, 
    // so we assume the user might need to run SQL or we use a basic Key-Value pattern if they have no table)
    // Check if table exists by trying to select
    const { error: checkError } = await supabase.from('app_config').select('*').limit(1);

    if (checkError && checkError.code === '42P01') {
        console.error('Table "app_config" does not exist. Please run this SQL in your Supabase SQL Editor:');
        console.log(`
      CREATE TABLE app_config (
        id bigint generated by default as identity primary key,
        key text unique not null,
        value jsonb not null,
        updated_at timestamp with time zone default timezone('utc'::text, now()) not null
      );
    `);
        // Ideally we would run this via RPC if allowed, but usually requires manual SQL run for security.
    } else {
        console.log('Table "app_config" seems to exist or another error occurred:', checkError?.message || 'OK');
    }

    // 3. Upsert content
    const { error: upsertError } = await supabase
        .from('app_config')
        .upsert({ key: 'site_content', value: content }, { onConflict: 'key' });

    if (upsertError) {
        console.error('Error uploading content:', upsertError);
    } else {
        console.log('Successfully uploaded content.json to Supabase!');
    }
}

setup();
